!function(t){var e={onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],_state:0};t.fn.keypopup=function(n){function o(t){var e=s[t.type].call(i,t,c);return e.invoke.call(i,c,e.matchInfo),void 0==e||e.bubby?void 0:(t.preventDefault(),t.stopPropagation(),!1)}function a(e){e._target||(e._target=t('<div style="position:absolute;width;z-index:-99999;overflow:hidden;visiblity:hidden;word-wrap: break-word;word-break:normal;"></div>').appendTo("body")[0])}var c=null,i=this[0],r=this;if("string"==typeof n){c=r.data("_keypopup");var u=[c].concat([].slice.call(arguments,1));l[n].apply(i,u)}else c=t.extend({},e,n),a(c),f.reset.call(i,c),r.data("_keypopup",c).mouseup(o).keydown(o).keyup(o).focus(function(){f.reset.call(this,c)});return r};var n={offset:function(e){return t(e).offset()},setSizePos:function(e,n){t(e).css(n)},height:function(e){return t(e).height()}},o={getSelection:function(){var t,e=this;if(window.getSelection)t=e.value.substring(0,e.selectionEnd);else{var n=document.selection.createRange(),o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToEnd",n),t=o.text}return t},setPos:function(t,e){var n=this;if(n.focus(),n.scrollTop=e,window.getSelection)n.selectionStart=n.selectionEnd=t;else if(n.createTextRange){var o=n.createTextRange(),a="character";o.collapse(!0),o.moveEnd(a,t),o.moveStart(a,t)}}},a="noop",c="focus",i="default",r="match",s={keyup:function(t,e){var n=229==t.which,o=38==t.which||39==t.which||40==t.which||37==t.which||8==t.which,c=a;27==t.which||32==t.which;var i=n||o?u.byCursor.call(this,e,n?0:1):u.always.call(this,e,t);return i&&(c=r),h[c].create(i)},keydown:function(t,e){var n=a;return 1==e._state&&(40==t.which&&(n=c),13==t.which&&(n=i)),h[n].create()},mouseup:function(t,e){f.reset.call(this,e);var n=u.byCursor.call(this,e);return n?h.match.create(n):h.noop.create()}},l={set:function(t,e){var n=this,a=t.matchInfo,c=a.start+e+a.end,i=a.content.substr(0,a.content.length-a.key.length).length,r=n.value,s=r.substr(0,i),l=r.substr(i+a.key.length),u=s+c+l;n.value=u,t._state=0,t.onMiss.call(n),o.setPos.call(n,i+c.length,a.scrollTop)},focus:function(t){var e=t.matchInfo;o.setPos.call(this,t,e.content.length,e.scrollTop)},hide:function(t){h.miss.create().invoke.call(this,t)}},u={byCursor:function(t,e){for(var n=void 0===e?1:e,a=o.getSelection.call(this),c=0;c<t.matches.length;c++){var i=t.matches[c],r=i.start,s=new RegExp(r+"[^"+r+"\\s]{"+n+",20}$","gi"),l=a.match(s);if(null!=l)return{content:a,key:l[0],start:i.start,end:i.end}}},always:function(t,e){for(var n=0;n<t.matches.length;n++){var a=t.matches[n];if(a.isMatch(e))return{start:a.start,end:a.end,key:a.start,content:o.getSelection.call(this,t)}}}},a="noop",c="focus",i="default",r="match",h={match:{create:function(t){return{matchInfo:t,invoke:function(t,e){f.render.call(this,t,e);var o=document.getElementById(t.atId),a=n.offset(o);a.top+=n.height(o)-this.scrollTop,e.offset=a,t._state=1,t.onMatch.call(this,e)},bubby:!1}}},miss:{create:function(){return{invoke:function(t){t.onMiss.call(this),t._state=0},bubby:!0}}},focus:{create:function(){return{invoke:function(t){"function"==typeof t.onFocus&&(t.onFocus.call(this),t._state=0)},bubby:!1}}},"default":{create:function(){return{invoke:function(t){var e=t.onDefault.call(this,t);e&&l.set.call(this,t,e)},bubby:!1}}},noop:{create:function(){return{invoke:function(){},bubby:!0}}}},f={reset:function(t){var e=this,o=n.offset(e);n.setSizePos(t._target,{width:e.clientWidth,height:e.clientHeight,left:o.left,top:o.top})},render:function(t,e){var n=e.content.substr(0,e.content.length-e.key.length),o=n.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");t.atId||(t.atId="at"+Math.round(201*Math.random())+(new Date).getTime()),t.matchInfo=e,t.matchInfo.scrollTop=this.scrollTop,t._target.innerHTML=o+"<span id='"+t.atId+"'>"+e.key+"</span>"}}}(jQuery);