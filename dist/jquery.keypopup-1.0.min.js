!function(t){t.fn.keypopup=function(s){var i={onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,isShow:!1,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],_state:0},o=null,l=t(this);if("string"==typeof s){o=l.data("_keypopup");var r=[o].concat([].slice.call(arguments,1));a[s].apply(l[0],r)}else{if(o=t.extend({},i,s),!o.atId){var h=(new Date).getTime(),u=Math.round(201*Math.random());o.atId="at"+u+h}l.data("_keypopup",o).mouseup(function(t){return c.reset.call(this,o),e.byCursor.call(this,o),t.stopPropagation(),t.preventDefault(),!1}).keydown(function(t){return console.log("keydown-"+t.which),1==o._state?(40==t.which&&n.focus.call(this,o),13==t.which&&(n["default"].call(this,o),console.log(t.cancelable),t.cancelable=!0),t.stopPropagation(),t.preventDefault(),!1):void 0}).keyup(function(t){console.log("keyup-"+t.which);var a=!1,s=229==t.which,c=38==t.which||39==t.which||40==t.which||37==t.which||8==t.which;if(27==t.which||32==t.which)return void n.miss.call(this,o);if(s||c)a=e.byCursor.call(this,o,s?0:1);else for(var i=0;i<o.matches.length;i++){var l=o.matches[i];if(l.isMatch(t)){a=!0,e.always.call(this,o,{start:l.start,end:l.end});break}}return t.stopPropagation(),t.preventDefault(),!1}),c.reset.call(this,o)}return l};var e={byCursor:function(t,a){for(var c=void 0===a?1:a,i=s.getSelection.call(this,t),o=0;o<t.matches.length;o++){var l=t.matches[o],r=l.start,h=new RegExp(r+"[^"+r+"\\s]{"+c+",20}$","gi"),u=i.match(h);if(null!=u){var f={content:i,key:u[0],start:l.start,end:l.end};return e._fire.call(this,t,f),!0}}return n.miss.call(this,t),!1},always:function(t,n){n.content=s.getSelection.call(this,t),n.key="@",e._fire.call(this,t,n)},_fire:function(t,e){c.render.call(this,t,e),n.match.call(this,t,e)}},n={"default":function(t){var e=t.onDefault.call(this,t);e&&a.set.call(this,t,e)},match:function(e,n){var a=t("#"+e.atId),s=a.offset();s.top+=a.height()-this.scrollTop,s.start=n.start,s.end=n.end,e._curMatch=s,e._state=1,e.onMatch.call(this,s)},miss:function(t){t.onMiss.call(this),t._state=0},focus:function(t){t.onFocus.call(this),t._state=0}},a={set:function(e,n){var a=this,n=e._curMatch.start+n+e._curMatch.end,c=t(this),i=e._target.data("_t"),o=i.contentLen,l=c.val(),r=l.substr(0,i.contentLen),h=l.substr(o+i.keyLen),u=r+n+h;console.log(JSON.stringify(i)),c.val(u),e._state=0,e.onMiss.call(a),s.setPos.call(a,e,o+n.length,i.scrollTop)},focus:function(t){s.setPos.call(this,t,t._target.text().length,t._target.data("_t").scrollTop)}},s={getSelection:function(t){var e,n=this;if(window.getSelection)e=n.value.substring(0,n.selectionEnd);else{var a=document.selection.createRange(),s=a.duplicate();s.moveToElementText(n),s.setEndPoint("EndToEnd",a),e=s.text}return e},setPos:function(e,n,a){var s=this;if(t(s).focus(),s.scrollTop=a,window.getSelection)s.selectionEnd=n,s.selectionStart=n;else if(s.createTextRange){var c=s.createTextRange(),i="character";c.collapse(!0),c.moveEnd(i,n),c.moveStart(i,n)}}},c={reset:function(e){var n=this,a=t(n),s=a.offset();e._target||(e._target=t('<div style="position:absolute;width;z-index:-99999;overflow:hidden;visiblity:hidden;word-wrap: break-word;word-break:normal;"></div>').appendTo("body")),e._target.css("width",n.clientWidth).css("height",n.clientHeight).css("left",s.left).css("top",s.top)},render:function(t,e){var n=e.content.substr(0,e.content.length-e.key.length),a=n.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");t._target.data("_t",{contentLen:n.length,keyLen:e.key.length,scrollTop:this.scrollTop}),t._target.html(a+"<span id='"+t.atId+"'>"+e.key+"</span>")}}}(jQuery);