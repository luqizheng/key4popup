!function(){function t(t,e){this.self=t,this.options=e,this.key="",this.start="",this.end="",this.content="",this.offset=function(){this.left,this.top},this.scrollTop=0,this.set=function(t){var e=this.self,n=this.options,o=this,s=o.start+t+o.end,i=o.content.substr(0,o.content.length-o.key.length).length,a=e.value,c=a.substr(0,i),r=a.substr(i+o.key.length),u=c+s+r;e.value=u,n._state=0,n.onMiss.call(e),l.setPos.call(e,i+s.length,o.scrollTop)},this.hide=function(){var t=this.options,e=this.options.matchInfo;c.miss.create().invoke.call(self,t),l.setPos.call(this.slef,t,e.content.length,e.scrollTop)},this.focus=function(){c.miss.create().invoke.call(this.self,this.options)}}function e(){window.console&&Function.apply.call(console.log,console,arguments)}var n="_keypopup_",o='<div id="'+n+'" style="position:absolute;width;z-index:-99999;overflow:hidden;visibility:hidden;word-wrap:break-word;word-break:normal;"></div>',s="_keypopup",i={onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,onLeave:!1,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],_state:0};$.fn.keypopup=function(t){function e(t){var e=v[t.type].call(l,t,c);return e.invoke.call(l,c,e.matchInfo),void 0==e||e.bubby?void 0:(t.preventDefault(),t.stopPropagation(),!1)}function a(t){if(!t._layout){var e=$("#"+n);0==e.length&&(e=$(o).appendTo("body")),t._layout=e[0]}}var c=null,l=this[0],r=this;if("string"==typeof t){c=r.data(s);var u=[c].concat([].slice.call(arguments,1));c.matchInfo[t].apply(l,u)}else c=$.extend({},i,t),a(c),d.reset.call(l,c),r.data(s,c).mouseup(e).keydown(e).keyup(e).mouseleave(e).focus(function(){d.reset.call(this,c)});return r};var a,c={match:{create:function(t){return{matchInfo:t,invoke:function(t,n){t.matchInfo&&t.matchInfo.hide(),t.matchInfo=n,t._state=1,t.onMatch||e("please onMatch fucntion  in options"),t.onMatch.call(self,n)},bubby:!1}}},leave:{create:function(t){return{matchInfo:t,invoke:function(t,n){var o=this;t._state=0,t.onLeave||e("please onLeave fucntion  in options"),t.onLeave.call(o,n)}}}},miss:{create:function(){return{invoke:function(t){t.onMiss||e("please onMiss fucntion  in options"),t.onMiss.call(this),t._state=0},bubby:!0}}},focus:{create:function(){return{invoke:function(t){t.onFocus||e("please onMiss fucntion  in options"),t.onFocus.call(this),t._state=0},bubby:!1}}},"default":{create:function(){return{invoke:function(t){t.onDefault||e("please onDefault fucntion  in options");var n=t.onDefault.call(this,t);n&&t.matchInfo.set(n)},bubby:!1}}},noop:{create:function(){return{invoke:function(){},bubby:!0}}}},l={getSelection:function(){var t,e=this;if(window.getSelection)t=e.value.substring(0,e.selectionEnd);else{var n=document.selection.createRange(),o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToEnd",n),t=o.text}return t},setPos:function(t,e){var n=this;if(n.focus(),n.scrollTop=e,window.getSelection)n.selectionStart=n.selectionEnd=t;else if(n.createTextRange){var o=n.createTextRange(),s="character";o.collapse(!0),o.moveEnd(s,t),o.moveStart(s,t)}}},r="noop",u="miss",f="focus",h="default",p="match",v={keyup:function(t,e){var n=t.which,o=38==n||39==n||40==n||37==n||8==n,s=r;if(27==n||32==n)s=u;else{var i=m.byCursor.call(this,e,o?1:0);i&&(s=p)}return c[s].create(i)},keydown:function(t,e){var n=r,o=t.which;return 1==e._state&&(40==o&&(n=f),13==o&&(n=h)),c[n].create()},mouseup:function(t,e){d.reset.call(this,e);var n=m.byCursor.call(this,e);return n?c.match.create(n):c.noop.create()},mouseleave:function(e,n){d.reset.call(this,n);var o=n.matchInfo;return 0!=n._status&&o||(o=new t(this,n)),o.content=l.getSelection.call(this),o.content||(o.content=this.value),c.leave.create(o)}},d={reset:function(t){var e=this,n=y.offset(e);y.setSizePos(t._layout,{width:e.clientWidth,height:e.clientHeight,left:n.left,top:n.top})},render:function(t,e){var n=e.content.substr(0,e.content.length-e.key.length),o=n.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");return a||(a="at"+Math.round(201*Math.random())+(new Date).getTime()),t._layout.innerHTML=o+"<span id='"+a+"'>"+e.key+"</span>",a}},b="\\s\\x20-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\x7e\\x80-\\xff\\u3000-\\u3002\\u300a\\u300b\\u300e-\\u3011\\u2014\\u2018\\u2019\\u201c\\u201d\\u2026\\u203b\\u25ce\\uff01-\\uff5e\\uffe5",m={byCursor:function(e,n){for(var o=void 0===n?1:n,s=this,i=l.getSelection.call(s),a=0;a<e.matches.length;a++){var c=e.matches[a],r=c.start,u=new RegExp(r+"[^"+r+b+"]{"+o+",20}$","gi"),f=i.match(u);if(null!=f){var h=new t(s,e);h.content=i,h.key=f[0],h.start=c.start,h.end=c.end,h.scrollTop=s.scrollTop;var p=d.render.call(this,e,h),v=document.getElementById(p),m=y.offset(v);return m.top+=y.height(v)-this.scrollTop,h.offset=m,h}}}},y={offset:function(t){return $(t).offset()},setSizePos:function(t,e){$(t).css(e)},height:function(t){return $(t).height()}}}(jQuery);