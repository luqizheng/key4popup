/// <reference path="../_MatchInfo.js" />
/// <reference path="../_globalDefined.js" />
/// <reference path="../_eventHandler.js" />
/*!
jquery.keypopup Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/key4popup 
*/
!function(t){function e(){window.console&&Function.apply.call(console.log,console,arguments)}function n(t,e){this.self=t,this.options=e,this.key="",this.start="",this.end="",this.content="",this.offset=function(){this.left,this.top},this.bookmark=null,this.scrollTop=0,this.set=function(t){var e=this.self,n=this.options,o=this,i=o.start+t+o.end,s=o.content.substr(0,o.content.length-o.key.length).length,a=e.value,u=a.substr(0,s),l=a.substr(s+o.key.length),r=u+i+l;e.value=r,n._state=0,n.onMiss.call(e),c.setPos.call(e,s+i.length,o.scrollTop,o)},this.hide=function(){var t=this.options;a.miss.create().invoke.call(this.self,t)},this.focus=function(){a.miss.create().invoke.call(this.self,this.options)}}var o="_keypopup_",i='<div id="'+o+'" style="position:absolute;width;z-index:-99999;overflow:hidden;visibility:hidden;word-wrap:break-word;word-break:normal;"/>';t.component("ms:keypopup",{$init:function(e,n){e.$ta=n.innerHTML;var s=document.getElementById(o);null==s&&(document.body.appendChild(t.parseHTML(i).childNodes[0]),s=document.getElementById(o)),e._layout=s},$replace:1,$ta:"",$$template:function(t,e){return this.$ta.replace(">",'ms-on-keyup="_keyup($event)" ms-on-keydown="_keydown($event)" ms-on-mouseup="_mouseup($event)" ms-on-mouseleave="_mouseleave" on-init="onInit">')},$ready:function(t,e){function o(e){var n=e.target,o=p[e.type].call(n,e,t);return o.invoke.call(n,t,o.matchInfo),void 0==o||o.bubby?void 0:(e.preventDefault(),e.stopPropagation(),!1)}t.matchInfo=new n(e,t),t.matchInfo.content=e.value,t.onInit(t.matchInfo),t._keyup=o,t._keydown=o,t._mouseup=o},_state:0,_keyup:!1,_keydown:!1,_mouseup:!1,_layout:null,_mouseleave:t.noop,onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,onLeave:t.noop,onInit:t.noop,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],matchInfo:null});var s,a={match:{create:function(t){return{matchInfo:t,invoke:function(t,n){t.matchInfo&&t.matchInfo.hide(),t.matchInfo=n,t._state=1,t.onMatch||e("please onMatch fucntion  in options"),t.onMatch.call(self,n)},bubby:!1}}},leave:{create:function(t){return{matchInfo:t,invoke:function(t,n){var o=this;t._state=0,t.onLeave||e("please onLeave fucntion  in options"),t.onLeave.call(o,n)}}}},miss:{create:function(){return{invoke:function(t){t.onMiss||e("please onMiss fucntion  in options"),t.onMiss.call(this),t._state=0},bubby:!0}}},focus:{create:function(){return{invoke:function(t){t.onFocus||e("please onMiss fucntion  in options"),t.onFocus.call(this),t._state=0},bubby:!1}}},"default":{create:function(){return{invoke:function(t){t.onDefault||e("please onDefault fucntion  in options");var n=t.onDefault.call(this,t);n&&t.matchInfo.set(n)},bubby:!1}}},noop:{create:function(){return{invoke:function(){},bubby:!0}}}},c={getSelection:function(){var t,e=this;if(window.getSelection)t=e.value.substring(0,e.selectionEnd);else{var n=document.selection.createRange(),o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToEnd",n),t=o.text}return t},setPos:function(t,e){var n=this;if(n.focus(),n.scrollTop=e,window.getSelection)n.selectionStart=n.selectionEnd=t;else if(n.createTextRange){var o=n.createTextRange(),i="character";o.collapse(!0),o.moveStart(i,t),o.select()}}},u="noop",l="miss",r="focus",f="default",h="match",p={keyup:function(t,e){var n=t.which,o=38==n||39==n||40==n||37==n||8==n,i=u;if(27==n||32==n)i=l;else{var s=m.byCursor.call(this,e,o?1:0);s&&(i=h)}return a[i].create(s)},keydown:function(t,e){var n=u,o=t.which;return 1==e._state&&(40==o&&(n=r),13==o&&(n=f)),a[n].create()},mouseup:function(t,e){d.reset.call(this,e);var n=m.byCursor.call(this,e);return n?a.match.create(n):a.noop.create()},mouseleave:function(t,e){d.reset.call(this,e);var o=e.matchInfo;return 0!=e._status&&o||(o=new n(this,e)),o.content=c.getSelection.call(this),o.content||(o.content=this.value),a.leave.create(o)}},d={reset:function(t){var e=this,n=y.offset(e);y.setSizePos(t._layout,{width:e.clientWidth,height:e.clientHeight,left:n.left,top:n.top})},render:function(t,e){var n=e.content.substr(0,e.content.length-e.key.length),o=n.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");return s||(s="at"+Math.round(201*Math.random())+(new Date).getTime()),t._layout.innerHTML=o+"<span id='"+s+"'>"+e.key+"</span>",s}},v="\\s\\x20-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\x7e\\x80-\\xff\\u3000-\\u3002\\u300a\\u300b\\u300e-\\u3011\\u2014\\u2018\\u2019\\u201c\\u201d\\u2026\\u203b\\u25ce\\uff01-\\uff5e\\uffe5",m={byCursor:function(t,e){for(var o=void 0===e?1:e,i=this,s=new n(i,t),a=c.getSelection.call(i),u=0;u<t.matches.length;u++){var l=t.matches[u],r=l.start,f=new RegExp(r+"[^"+r+v+"]{"+o+",20}$","gi"),h=a.match(f);if(null!=h){s.content=a,s.key=h[0],s.start=l.start,s.end=l.end,s.scrollTop=i.scrollTop;var p=d.render.call(this,t,s),m=document.getElementById(p),b=y.offset(m);return b.top+=y.height(m)-this.scrollTop,s.offset=b,s}}}},y={offset:function(e){return t(e).offset()},setSizePos:function(e,n){t(e).css(n)},height:function(e){return t(e).height()}}}(window.avalon);