!function(t){function e(t,e){this.self=t,this.options=e,this.key="",this.start="",this.end="",this.content="",this.offset=function(){this.left,this.top},this.scrollTop=0,this.set=function(t){var e=this.self,n=this.options,o=this,i=o.start+t+o.end,a=o.content.substr(0,o.content.length-o.key.length).length,c=e.value,r=c.substr(0,a),u=c.substr(a+o.key.length),l=r+i+u;e.value=l,n._state=0,n.onMiss.call(e),s.setPos.call(e,a+i.length,o.scrollTop)},this.hide=function(){var t=this.options,e=this.options.matchInfo;o.miss.create().invoke.call(self,t),s.setPos.call(this.slef,t,e.content.length,e.scrollTop)},this.focus=function(){o.miss.create().invoke.call(this.self,this.options)}}t.component("ms:keypopup",{$init:function(e,n){var o=t.parseHTML('<div style="position:absolute;width;z-index:-99999;overflow:hidden;visiblity:hidden;word-wrap:break-word;word-break:normal;"></div>');e._target=document.body.appendChild(o.childNodes[0]),e.$ta=n.innerHTML},$replace:1,$ta:"",$$template:function(t,e){return this.$ta.replace(">",'ms-on-keyup="_keyup($event)" ms-on-keydown="_keydown($event)" ms-on-mouseup="_mouseup($event)" ms-on-mouseleave="_mouseleave">')},$ready:function(t){function e(e){var n=e.target,o=l[e.type].call(n,e,t);return o.invoke.call(n,t,o.matchInfo),void 0==o||o.bubby?void 0:(e.preventDefault(),e.stopPropagation(),!1)}t._keyup=e,t._keydown=e,t._mouseup=e,t._mouseleave=e},_keyup:t.noop,_keydown:t.noop,_mouseup:t.noop,_target:null,_mouseleave:t.noop,onMatch:t.noop,onMiss:t.noop,onFocus:t.noop,onDefault:t.noop,onLeave:t.noop,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],matchInfo:{content:"",key:"",start:"",end:"",offset:{left:0,top:0},set:t.noop,focus:t.noop,hide:t.noop}});var n,o={match:{create:function(t){return{matchInfo:t,invoke:function(t,e){t.matchInfo&&t.matchInfo.hide(),t.matchInfo=e,t._state=1,t.onMatch.call(self,e)},bubby:!1}}},leave:{create:function(t){return{matchInfo:t,invoke:function(t,e){var n=this;t._state=0,t.onLeave.call(n,e)}}}},miss:{create:function(){return{invoke:function(t){t.onMiss.call(this),t._state=0},bubby:!0}}},focus:{create:function(){return{invoke:function(t){"function"==typeof t.onFocus&&(t.onFocus.call(this),t._state=0)},bubby:!1}}},"default":{create:function(){return{invoke:function(t){var e=t.onDefault.call(this,t);e&&t.matchInfo.set(e)},bubby:!1}}},noop:{create:function(){return{invoke:function(){},bubby:!0}}}},s={getSelection:function(){var t,e=this;if(window.getSelection)t=e.value.substring(0,e.selectionEnd);else{var n=document.selection.createRange(),o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToEnd",n),t=o.text}return t},setPos:function(t,e){var n=this;if(n.focus(),n.scrollTop=e,window.getSelection)n.selectionStart=n.selectionEnd=t;else if(n.createTextRange){var o=n.createTextRange(),s="character";o.collapse(!0),o.moveEnd(s,t),o.moveStart(s,t)}}},i="noop",a="miss",c="focus",r="default",u="match",l={keyup:function(t,e){var n=t.which,s=38==n||39==n||40==n||37==n||8==n,c=i;if(27==n||32==n)c=a;else{var r=p.byCursor.call(this,e,s?1:0);r&&(c=u)}return o[c].create(r)},keydown:function(t,e){var n=i,s=t.which;return 1==e._state&&(40==s&&(n=c),13==s&&(n=r)),o[n].create()},mouseup:function(t,e){h.reset.call(this,e);var n=p.byCursor.call(this,e);return n?o.match.create(n):o.noop.create()},mouseleave:function(t,n){h.reset.call(this,n);var i=new e(this,n);return i.content=s.getSelection.call(this),i.content||(i.content=this.value),o.leave.create(i)}},h={reset:function(t){var e=this,n=d.offset(e);d.setSizePos(t._target,{width:e.clientWidth,height:e.clientHeight,left:n.left,top:n.top})},render:function(t,e){var o=e.content.substr(0,e.content.length-e.key.length),s=o.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");return n||(n="at"+Math.round(201*Math.random())+(new Date).getTime()),t._target.innerHTML=s+"<span id='"+n+"'>"+e.key+"</span>",n}},f="\\s\\x20-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\x7e\\x80-\\xff\\u3000-\\u3002\\u300a\\u300b\\u300e-\\u3011\\u2014\\u2018\\u2019\\u201c\\u201d\\u2026\\u203b\\u25ce\\uff01-\\uff5e\\uffe5",p={byCursor:function(t,n){for(var o=void 0===n?1:n,i=this,a=s.getSelection.call(i),c=0;c<t.matches.length;c++){var r=t.matches[c],u=r.start,l=new RegExp(u+"[^"+u+f+"]{"+o+",20}$","gi"),p=a.match(l);if(null!=p){var v=new e(i,t);v.content=a,v.key=p[0],v.start=r.start,v.end=r.end,v.scrollTop=i.scrollTop;var m=h.render.call(this,t,v),b=document.getElementById(m),y=d.offset(b);return y.top+=d.height(b)-this.scrollTop,v.offset=y,v}}}},d={offset:function(e){return t(e).offset()},setSizePos:function(e,n){t(e).css(n)},height:function(e){return t(e).height()}}}(window.avalon);