/*!
jquery.keypopup Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/key4popup 
*/
!function(){function t(){window.console&&Function.apply.call(console.log,console,arguments)}function e(t,e){this.self=t,this.options=e,this.key="",this.start="",this.end="",this.content="",this.offset=function(){this.left,this.top},this.scrollTop=0,this.set=function(t){var e=this.self,n=this.options,o=this,i=o.start+t+o.end,s=o.content.substr(0,o.content.length-o.key.length).length,a=e.value,c=a.substr(0,s),r=a.substr(s+o.key.length),u=c+i+r;e.value=u,n._state=0,n.onMiss.call(e),h.setPos.call(e,s+i.length,o.scrollTop,o)},this.hide=function(){var t=this.options;r.miss.create().invoke.call(this.self,t)},this.focus=function(){r.miss.create().invoke.call(this.self,this.options)},this.isMatch=function(){return!!this.key}}function n(t,e){var n,o=e.target,i=!0,s=g[e.type].call(o,e,t);return s.matchInfo&&r.cursorChanged.create().invoke.call(o,t,s.matchInfo),s.eventName!=f&&(n=r[s.eventName].create(),i=n.bubby,n.invoke.call(o,t,s.matchInfo)),i?void 0:(e.preventDefault(),e.stopPropagation(),!1)}var o="_keypopup_",i='<div id="'+o+'" style="position:absolute;width;z-index:-99999;overflow:hidden;visibility:hidden;word-wrap:break-word;word-break:normal;"/>',s="_keypopup",a={onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,onCursorChanged:!1,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],_state:0};$.fn.keypopup=function(t){function c(t){return n(u,t)}function r(t){if(!t._layout){var e=$("#"+o);0==e.length&&(e=$(i).appendTo("body")),t._layout=e[0]}}var u=null,l=this[0],h=this;if("string"==typeof t){u=h.data(s);var f=[].concat([].slice.call(arguments,1));u.matchInfo[t](f)}else u=$.extend({},a,t),r(u),y.reset.call(l,u),h.data(s,u).mouseup(c).keydown(c).keyup(c),u.matchInfo=new e(l,u),u.matchInfo.content=l.value,u.onCursorChanged(u.matchInfo);return h};var c,r={match:{create:function(){return{invoke:function(t,e){u(t,e),l(t,"onMatch",1)},bubby:!1}}},cursorChanged:{create:function(t){return{matchInfo:t,invoke:function(t,e){u(t,e),l(t,"onCursorChanged")},bubby:!0}}},miss:{create:function(){return{invoke:function(t){l.call(this,t,"onMiss",0)},bubby:!0}}},focus:{create:function(){return{invoke:function(t){l.call(this,t,"onFocus",0)},bubby:!1}}},"default":{create:function(){return{invoke:function(t){var e=l.call(this,t,"onDefault",1);e&&t.matchInfo.set(e)},bubby:!1}}}},u=function(t,e){t.matchInfo.key&&t.matchInfo.hide(),t.matchInfo=e},l=function(e,n,o){return e[n]||t("please define"+n+" fucntion  in options"),void 0!==o&&(e._state=o),e[n].call(this,e.matchInfo)},h={getSelection:function(){var t,e=this;if(window.getSelection)t=e.value.substring(0,e.selectionEnd);else{var n=document.selection.createRange(),o=n.duplicate();o.moveToElementText(e),o.setEndPoint("EndToEnd",n),t=o.text}return t},setPos:function(t,e){var n=this;if(n.focus(),n.scrollTop=e,window.getSelection)n.selectionStart=n.selectionEnd=t;else if(n.createTextRange){var o=n.createTextRange(),i="character";o.collapse(!0),o.moveStart(i,t),o.select()}}},f="noop",d="miss",p="focus",v="default",m="match",g={keydown:function(t,e){var n=f,o=t.which;return 1==e._state&&(40==o?n=p:13==o&&(n=v)),{eventName:n,matchInfo:!1}},keyup:function(t,e){var n=t.which,o=38==n||39==n||40==n||37==n||8==n,i=f,s=k.byCursor.call(this,e,o?1:0);return 27==n||32==n?i=d:s.isMatch()&&(i=m),{eventName:i,matchInfo:s}},mouseup:function(t,e){y.reset.call(this,e);var n=k.byCursor.call(this,e);return{matchInfo:n,eventName:n.isMatch()?m:f}}},y={reset:function(t){var e=this,n=w.offset(e);w.setSizePos(t._layout,{width:e.clientWidth,height:e.clientHeight,left:n.left,top:n.top})},render:function(t,e){var n=e.content.substr(0,e.content.length-e.key.length),o=n.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;");return c||(c="at"+Math.round(201*Math.random())+(new Date).getTime()),t._layout.innerHTML=o+"<span id='"+c+"'>"+e.key+"</span>",c}},b="\\s\\x20-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\x7e\\x80-\\xff\\u3000-\\u3002\\u300a\\u300b\\u300e-\\u3011\\u2014\\u2018\\u2019\\u201c\\u201d\\u2026\\u203b\\u25ce\\uff01-\\uff5e\\uffe5",k={byCursor:function(t,n){var o=void 0===n?1:n,i=this,s=new e(i,t),a=h.getSelection.call(i);s.content=a,s.scrollTop=i.scrollTop;for(var c=0;c<t.matches.length;c++){var r=t.matches[c],u=r.start,l=new RegExp(u+"[^"+u+b+"]{"+o+",20}$","gi"),f=a.match(l);if(null!=f){s.key=f[0],s.start=r.start,s.end=r.end;var d=y.render.call(this,t,s),p=document.getElementById(d),v=w.offset(p);return v.top+=w.height(p)-this.scrollTop,s.offset=v,s}}return s}},w={offset:function(t){return $(t).offset()},setSizePos:function(t,e){$(t).css(e)},height:function(t){return $(t).height()}}}(jQuery);