!function(t){t.fn.keypopup=function(s){var l={onMatch:!1,onMiss:!1,onFocus:!1,onDefault:!1,isShow:!1,matches:[{start:"@",end:" ",isMatch:function(t){return 50===t.which&&t.shiftKey}},{start:"#",end:"# ",isMatch:function(t){return 51===t.which&&t.shiftKey}}],_state:0},r=null,o=t(this);if("string"==typeof s){r=o.data("_keypopup");var h=[r].concat([].slice.call(arguments,1));n[s].apply(o[0],h)}else{if(r=t.extend({},l,s),!r.atId){var u=(new Date).getTime(),f=Math.round(201*Math.random());r.atId="at"+f+u}o.data("_keypopup",r).mouseup(function(t){return i.reset.call(this),e.byCursor.call(this,r),t.stopPropagation(),t.preventDefault(),!1}).keyup(function(t){console.log(t.which);var n=!1,s=!1,i=229==t.which,c=i||38==t.which||39==t.which||40==t.which||37==t.which||8==t.which;if(27==t.which||32==t.which)return void a.miss.call(this,r);if(1==r._state&&(40==t.which&&(a.focus.call(this,r),n=!0),13==t.which&&(a["default"].call(this,r),n=!0)),!n)if(i||c)s=e.byCursor.call(this,r,c?1:0);else for(var l=0;l<r.matches.length;l++){var o=r.matches[l];if(o.isMatch(t)){s=!0,e.always.call(this,r,{start:o.start,end:o.end});break}}return t.stopPropagation(),t.preventDefault(),!1}),c.call(this)}return o};var e={byCursor:function(t,n){for(var i=n||1,c=s.getSelection.call(this,t),l=0;l<t.matches.length;l++){var r=t.matches[l],o=r.start,h=new RegExp(o+"[^"+o+"\\s]{"+i+",20}$","gi"),u=c.match(h);if(null!=u){var f={content:c.substring(0,c.length-u[0].length),key:u[0],start:r.start,end:r.end};return e._fire.call(this,t,f),!0}}return a.miss.call(this,t),!1},always:function(t,a){var n=s.getSelection.call(this,t);a.content=n.substring(0,n.length-1),a.key="&nbsp;",e._fire.call(this,t,a)},_fire:function(t,e){i.render.call(this,t,e),a.match.call(this,t,e)}},a={"default":function(t){var e=t.onDefault.call(this,t);e&&n.set.call(this,t,e)},match:function(e,a){var n=t("#"+e.atId),s=n.offset();s.top+=n.height(),s.start=a.start,s.end=a.end,e._curMatch=s,e._state=1,e.onMatch.call(this,s)},miss:function(t){t.onMiss.call(this),t._state=0},focus:function(t){t.onFocus.call(this),t._state=0}},n={set:function(e,a){var n=this,a=e._curMatch.start+a+e._curMatch.end,i=t(this),c=e._target,l=c.find("#"+e.atId).text().length,r=c.text().length,o=i.val(),h=o.substr(0,r-l),u=o.substr(r),f=h+a+u;i.val(f),e._state=0,e.onMiss.call(n),s.setPos.call(n,e,r-l+a.length)},focus:function(t){s.setPos.call(this,t,t._target.text().length)}},s={getSelection:function(t){var e,a=this;if(window.getSelection)e=a.value.substring(0,a.selectionEnd);else{var n=document.selection.createRange(),s=n.duplicate();s.moveToElementText(a),s.setEndPoint("EndToEnd",n),e=s.text}return e},setPos:function(e,a){var n=this;if(t(n).focus(),window.getSelection)n.selectionEnd=a,n.selectionStart=a;else if(n.createTextRange){var s=n.createTextRange(),i="character";s.collapse(!0),s.moveEnd(i,a),s.moveStart(i,a)}}},i={reset:function(){var e=this,a=t(e),n=a.data("_keypopup"),s=a.offset();n._target||(n._target=t('<div style="position:absolute;width;z-index:-99999;overflow:hidden;visiblity:hidden"></div>').appendTo("body")),n._target.css("width",e.clientWidth).css("height",e.clientHeight).css("left",s.left).css("top",s.top)},render:function(t,e){var a=e.content.replace(/[\r\n]/g,"<br>").replace(/ /g,"&nbsp;"),n=e.key;t._target.html(a+"<span id='"+t.atId+"'>"+n+"</span>")}},c=i.reset}(jQuery);