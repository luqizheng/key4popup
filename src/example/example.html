<!DOCTYPE html>
<html>

<head>
    <title>jQuery at-username plugin example</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="reply">
        <textarea class="at-username" rows="4" cols="40">汽油涨价了，苹果涨价了@娃娃造型 ，鸡蛋涨价了，萝卜涨价了，方便面涨价了@文澜 我们欣喜的发现，空气不但没有涨价，而且里面的料还越来越多了.. ..但中国人还要坚强地活下去，因为墓地也涨价了</textarea>
    </div>

    <div class="list-group" style="position:absolute;display:none">        
        <a href="#Leolu" class="list-group-item">LeoLu</a>
        <a href="#中文名" class="list-group-item">中文名</a>
        <a href="#wht" class="list-group-item">wht</a>
        <a href="#Michale" class="list-group-item">Michale</a>
    </div>


    <script src="../js/jquery.keypopup.js"></script>
    <!--<script src="https://raw.github.com/mrkipling/jQuery-at-username/master/at-username/jquery.at-username.js"></script>-->
    <script>
        $("body").mouseup(function(e){
		$(".list-group").hide();
	});
   
        $('textarea').keypopup({
			onMatch:function(pos){				
				$(".list-group")
					.css("left",pos.left)
					.css("top",pos.top+5)
				.show().find("a:first").addClass("active")
				.focus();				
			},
			onMiss:function(){
				$(".list-group").hide();
			}			
		});
		
		$(".list-group").keyup(function(e){
			console.log(e.which)
			if(e.which == 27 ){ //ESC
				$(this).hide();
				return;
			}
		
		  var $this = $(this).find("a.active"),$nextActive=[] ;
		   switch(e.which){
			  case 38: //up
			    $nextActive=$this.prev();				
				break;
			  case 40: //down;
			    $nextActive=$this.next();				
				break;	
              case 13:
                var text=$this.children("a.active").attr("href").substr(1);
                console.log(text);
                $("textarea").keypopup('set',text)
                break;		  
		   }			
		   if($nextActive.length!=0)
			{
                $this.removeClass("active");
                $nextActive.addClass("active").focus();
			}
		}).children("a").click(function(){
            var text=$(this).attr("href").substr(1);
            console.log(text);
            $("textarea").keypopup('set',"@"+text)
            $(".list-group").hide().children("a");
        })
    </script>


</body>

</html>